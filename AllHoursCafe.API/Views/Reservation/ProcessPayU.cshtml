@model AllHoursCafe.API.Models.Reservation

@{
    ViewData["Title"] = "Redirecting to PayU";
}

<link rel="stylesheet" href="/css/payment-processing.css" />

<section class="payment-processing-section">
    <div class="container">
        <div class="payment-processing-content">
            <div class="processing-icon">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Processing...</span>
                </div>
            </div>
            <h1>Redirecting to PayU Payment Gateway</h1>
            <p>Please wait while we redirect you to the secure PayU payment gateway...</p>

            <div class="reservation-details">
                <h2>Reservation Details</h2>
                <div class="detail-row">
                    <span class="detail-label">Reservation ID:</span>
                    <span class="detail-value">#@Model.Id</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">@Model.Name</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date & Time:</span>
                    <span class="detail-value">@Model.ReservationDate.ToString("dd MMM yyyy") at @Model.ReservationTime.ToString("hh:mm tt")</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Guests:</span>
                    <span class="detail-value">@Model.NumberOfGuests @(Model.NumberOfGuests == 1 ? "person" : "people")</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Amount:</span>
                    <span class="detail-value">â‚¹500.00</span>
                </div>
            </div>

            <div class="redirect-form-container">
                @if (ViewBag.PayUForm != null)
                {
                    <div id="payuFormContainer">
                        @Html.Raw(ViewBag.PayUForm)
                    </div>
                    <div class="manual-redirect">
                        <p>If you are not automatically redirected, please click the button above to proceed to payment.</p>
                    </div>
                }
                else
                {
                    <div class="alert alert-danger">Unable to generate payment form. Please try again.</div>
                    <a href="@Url.Action("Payment", new { id = Model.Id })" class="btn btn-primary">Try Again</a>
                }
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ProcessPayU script loaded');

            // Get references to elements
            const payuForm = document.getElementById('payuForm');
            const payuSubmitBtn = document.getElementById('payuSubmitBtn');

            console.log('PayU Form found:', payuForm !== null);
            console.log('PayU Submit Button found:', payuSubmitBtn !== null);

            // Add click event listener to the submit button
            if (payuSubmitBtn) {
                console.log('Adding click event listener to submit button');
                payuSubmitBtn.addEventListener('click', function(e) {
                    console.log('Submit button clicked');
                    e.preventDefault(); // Prevent default form submission

                    // Change button text and disable it
                    payuSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                    payuSubmitBtn.disabled = true;

                    // Submit the form after a short delay
                    setTimeout(function() {
                        console.log('Submitting form after delay');
                        if (payuForm) {
                            payuForm.submit();
                            console.log('Form submitted via button click');
                        } else {
                            console.error('PayU form not found when trying to submit');
                        }
                    }, 500);
                });
            }

            // Don't auto-submit the form, let the user click the button
            // This gives them a chance to review the reservation details
        });
    </script>
}
