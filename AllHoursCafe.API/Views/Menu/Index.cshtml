@model IEnumerable<AllHoursCafe.API.Models.Category>
@using AllHoursCafe.API.Models

@{
    ViewData["Title"] = "Menu";
    var menuItems = ViewBag.MenuItems as IEnumerable<MenuItem> ?? new List<MenuItem>();
}

<section class="menu-section">
    <div class="container menu-container">
        <div class="menu-header">
            <h1>Our Menu</h1>
            <div class="menu-filters">
                <div class="category-dropdown">
                    <button id="categoryButton" class="category-button">
                        <span>Categories</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="categoryDropdown" class="category-dropdown-content">
                        <div class="category-item active" data-category="all">
                            <span>All Items</span>
                        </div>
                        @foreach (var category in Model)
                        {
                            <div class="category-item" data-category="@category.Id">
                                <span>@category.Name</span>
                            </div>
                        }
                    </div>
                </div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search menu items...">
                    <button id="searchButton"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
        {
            <div class="error-message">
                <p>@ViewBag.ErrorMessage</p>
                <button class="retry-button" onclick="location.reload()">Retry</button>
            </div>
        }
        else if (!Model.Any())
        {
            <div class="error-message">
                <p>No menu categories available. Please try again later.</p>
                <button class="retry-button" onclick="location.reload()">Retry</button>
            </div>
        }
        else
        {
            <div class="menu-content">
                <!-- Cart dropdown has been removed -->

                <!-- Menu items container -->
                <div class="menu-items-container" id="menuItemsContainer">
                    @if (!menuItems.Any())
                    {
                        <div class="no-items-message">
                            <p>No menu items available. Please try again later.</p>
                        </div>
                    }
                    else
                    {
                        <!-- Group menu items by category -->
                        <div id="category-all" class="category-section" data-category="all">
                            <h2 class="category-title">All Items</h2>
                            <div class="items-grid">
                                @foreach (var item in menuItems)
                                {
                                    <div class="menu-item-card">
                                        <div class="menu-item-image">
                                            @{
                                                // Debug the image URL
                                                var rawImageUrl = item.ImageUrl;
                                                var categoryName = item.Category?.Name?.ToLower() ?? "other";

                                                // Use the actual image URL from the database
                                                var imageUrl = string.IsNullOrEmpty(rawImageUrl)
                                                    ? "/images/menu/placeholder.jpg"
                                                    : rawImageUrl;

                                                // Add crossorigin attribute to the image tag for external URLs
                                                var crossOrigin = imageUrl.StartsWith("http") ? "anonymous" : null;
                                            }
                                            <img src="@imageUrl" alt="@item.Name" onerror="this.src='/images/menu/placeholder.jpg?v=' + new Date().getTime(); console.log('Image failed to load: ' + '@imageUrl');" @(crossOrigin != null ? $"crossorigin=\"{crossOrigin}\"" : "")>
                                        </div>
                                        <div class="item-details">
                                            <div class="item-header">
                                                <h3 class="item-name">@item.Name</h3>
                                                <span class="item-price">₹@item.Price.ToString("F2")</span>
                                            </div>
                                            <p class="item-description">@item.Description</p>
                                            <div class="item-meta">
                                                @if (item.IsVegetarian)
                                                {
                                                    <span class="badge vegetarian">Vegetarian</span>
                                                }
                                                @if (item.IsVegan)
                                                {
                                                    <span class="badge vegan">Vegan</span>
                                                }
                                                @if (item.IsGlutenFree)
                                                {
                                                    <span class="badge gluten-free">Gluten Free</span>
                                                }
                                                @if (!string.IsNullOrEmpty(item.SpicyLevel))
                                                {
                                                    <span class="badge spicy">Spicy: @item.SpicyLevel</span>
                                                }
                                            </div>
                                            <div class="item-order-controls" data-item-id="@item.Id">
                                                <button class="order-button" onclick="addToCart(@item.Id, '@item.Name', @item.Price, '@imageUrl')">Add to Cart</button>
                                                <div class="quantity-control" style="display: none;">
                                                    <button class="quantity-btn decrease" onclick="updateQuantity(@item.Id, getItemQuantityInCart(@item.Id) - 1)">-</button>
                                                    <span class="quantity-display">0</span>
                                                    <button class="quantity-btn increase" onclick="updateQuantity(@item.Id, getItemQuantityInCart(@item.Id) + 1)">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Display menu items by category -->
                        @foreach (var category in Model)
                        {
                            var categoryItems = menuItems.Where(m => m.CategoryId == category.Id).ToList();
                            if (categoryItems.Any())
                            {
                                <div id="category-@category.Id" class="category-section" data-category="@category.Id" style="display: none;">
                                    <h2 class="category-title">@category.Name</h2>
                                    <div class="items-grid">
                                        @foreach (var item in categoryItems)
                                        {
                                            <div class="menu-item-card">
                                                <div class="menu-item-image">
                                                    @{
                                                        // Debug the image URL
                                                        var rawImageUrl = item.ImageUrl;
                                                        var categoryName = item.Category?.Name?.ToLower() ?? "other";

                                                        // Use the actual image URL from the database
                                                        var imageUrl = string.IsNullOrEmpty(rawImageUrl)
                                                            ? "/images/menu/placeholder.jpg"
                                                            : rawImageUrl;

                                                        // Add crossorigin attribute to the image tag for external URLs
                                                        var crossOrigin = imageUrl.StartsWith("http") ? "anonymous" : null;
                                                    }
                                                    <img src="@imageUrl" alt="@item.Name" onerror="this.src='/images/menu/placeholder.jpg?v=' + new Date().getTime(); console.log('Image failed to load: ' + '@imageUrl');" @(crossOrigin != null ? $"crossorigin=\"{crossOrigin}\"" : "")>
                                                </div>
                                                <div class="item-details">
                                                    <div class="item-header">
                                                        <h3 class="item-name">@item.Name</h3>
                                                        <span class="item-price">₹@item.Price.ToString("F2")</span>
                                                    </div>
                                                    <p class="item-description">@item.Description</p>
                                                    <div class="item-meta">
                                                        @if (item.IsVegetarian)
                                                        {
                                                            <span class="badge vegetarian">Vegetarian</span>
                                                        }
                                                        @if (item.IsVegan)
                                                        {
                                                            <span class="badge vegan">Vegan</span>
                                                        }
                                                        @if (item.IsGlutenFree)
                                                        {
                                                            <span class="badge gluten-free">Gluten Free</span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(item.SpicyLevel))
                                                        {
                                                            <span class="badge spicy">Spicy: @item.SpicyLevel</span>
                                                        }
                                                    </div>
                                                    <div class="item-order-controls" data-item-id="@item.Id">
                                                        <button class="order-button" onclick="addToCart(@item.Id, '@item.Name', @item.Price, '@imageUrl')">Add to Cart</button>
                                                        <div class="quantity-control" style="display: none;">
                                                            <button class="quantity-btn decrease" onclick="updateQuantity(@item.Id, getItemQuantityInCart(@item.Id) - 1)">-</button>
                                                            <span class="quantity-display">0</span>
                                                            <button class="quantity-btn increase" onclick="updateQuantity(@item.Id, getItemQuantityInCart(@item.Id) + 1)">+</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        }
    </div>
</section>

<!-- Floating cart toggle button -->
<button id="floatingCartToggle" class="floating-cart-toggle hidden">
    <i class="fas fa-shopping-cart"></i>
    <span class="cart-count" id="floatingCartCount">0</span>
</button>

<!-- Floating cart -->
<div id="floatingCart" class="floating-cart hidden" onclick="event.stopPropagation();">
    <div class="floating-cart-header">
        <div class="cart-icon-container">
            <i class="fas fa-shopping-cart"></i>
            <span>Your Cart</span>
        </div>
        <span class="cart-total" id="floatingCartTotal">₹0.00</span>
        <button id="closeFloatingCart" class="close-cart-btn">&times;</button>
    </div>
    <div class="floating-cart-items" id="floatingCartItems">
        <!-- Cart items will be added here dynamically -->
    </div>
    <div class="floating-cart-footer">
        <button id="floatingCheckoutBtn" class="checkout-button" onclick="proceedToCheckout()">Checkout</button>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="/css/menu-responsive.css">
    <link rel="stylesheet" href="/css/menu-quantity-controls.css">
    <link rel="stylesheet" href="/css/menu-no-cart.css">
    <link rel="stylesheet" href="/css/floating-cart.css">
}

@section Scripts {
    <script>
        // Cart toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const floatingCartToggle = document.getElementById('floatingCartToggle');
            const floatingCart = document.getElementById('floatingCart');
            const closeFloatingCart = document.getElementById('closeFloatingCart');

            if (floatingCartToggle && floatingCart) {
                // Open cart when toggle button is clicked
                floatingCartToggle.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event from bubbling up
                    floatingCart.classList.remove('hidden');
                    floatingCartToggle.classList.add('hidden');

                    // Update floating cart items to ensure they're current
                    if (typeof updateFloatingCartItems === 'function') {
                        updateFloatingCartItems();
                    }
                });

                // Close cart when close button is clicked
                if (closeFloatingCart) {
                    closeFloatingCart.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent event from bubbling up
                        floatingCart.classList.add('hidden');
                        floatingCartToggle.classList.remove('hidden');
                    });
                }

                // Close cart when clicking outside
                document.addEventListener('click', function(e) {
                    // Only process if cart is visible
                    if (!floatingCart.classList.contains('hidden')) {
                        // Check if click is outside the cart and not on the toggle button
                        if (!floatingCart.contains(e.target) && e.target !== floatingCartToggle) {
                            floatingCart.classList.add('hidden');
                            // Only show toggle if cart has items
                            if (window.cart && window.cart.length > 0) {
                                floatingCartToggle.classList.remove('hidden');
                            }
                        }
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {

            // Category dropdown toggle
            const categoryButton = document.getElementById('categoryButton');
            const categoryDropdown = document.getElementById('categoryDropdown');

            if (categoryButton && categoryDropdown) {
                categoryButton.addEventListener('click', function() {
                    const dropdown = document.querySelector('.category-dropdown');
                    dropdown.classList.toggle('active');
                    categoryDropdown.style.display = categoryDropdown.style.display === 'block' ? 'none' : 'block';
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.category-dropdown')) {
                        categoryDropdown.style.display = 'none';
                        document.querySelector('.category-dropdown').classList.remove('active');
                    }
                });
            }

            // Category switching
            const categoryItems = document.querySelectorAll('.category-item');
            let isScrolling = false; // Flag to prevent multiple clicks while scrolling

            categoryItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();

                    if (isScrolling) return; // Prevent multiple clicks while scrolling

                    // Remove active class from all categories
                    categoryItems.forEach(cat => cat.classList.remove('active'));

                    // Add active class to clicked category
                    this.classList.add('active');

                    // Get category ID
                    const categoryId = this.getAttribute('data-category');

                    // Update category button text if it's a dropdown item
                    if (this.closest('.category-dropdown-content')) {
                        categoryButton.querySelector('span').textContent = this.querySelector('span').textContent;
                        categoryDropdown.style.display = 'none';
                        document.querySelector('.category-dropdown').classList.remove('active');
                    }

                    // Hide all category sections
                    document.querySelectorAll('.category-section').forEach(section => {
                        section.style.display = 'none';
                    });

                    // Show the selected category section
                    const targetSection = document.getElementById(`category-${categoryId}`);
                    if (targetSection) {
                        targetSection.style.display = 'block';

                        // Don't scroll if it's the 'all' category
                        if (categoryId === 'all') {
                            window.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                            return;
                        }

                        // Calculate scroll position with offset for header
                        const menuSection = document.querySelector('.menu-section');
                        const menuSectionTop = menuSection.offsetTop;
                        const headerOffset = 120; // Adjust based on your header height

                        isScrolling = true;

                        // Smooth scroll to just below the menu section header
                        window.scrollTo({
                            top: menuSectionTop + headerOffset,
                            behavior: 'smooth'
                        });

                        // Reset scrolling flag after animation completes
                        setTimeout(() => {
                            isScrolling = false;
                        }, 800); // Typical scroll animation duration
                    }
                });
            });

            // Search functionality
            function performSearch() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const menuItems = document.querySelectorAll('.menu-item-card');

                // If search term is empty, show all items and return
                if (!searchTerm) {
                    menuItems.forEach(item => {
                        item.style.display = 'flex';
                    });
                    return;
                }

                // Show the "All Items" category when searching
                document.querySelectorAll('.category-section').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById('category-all').style.display = 'block';

                // Update active category in sidebar
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-category') === 'all') {
                        item.classList.add('active');
                    }
                });

                // Filter menu items
                menuItems.forEach(item => {
                    const name = item.querySelector('.item-name').textContent.toLowerCase();
                    const description = item.querySelector('.item-description').textContent.toLowerCase();

                    if (name.includes(searchTerm) || description.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            // Set up search input event
            document.getElementById('searchInput').addEventListener('input', performSearch);

            // Set up search button click
            document.getElementById('searchButton').addEventListener('click', function(e) {
                e.preventDefault();
                performSearch();
            });

            // Function to check authentication before checkout
            window.proceedToCheckout = function() {
                // Check if user is authenticated
                var isAuthenticated = @(User.Identity != null && User.Identity.IsAuthenticated ? "true" : "false");

                if (isAuthenticated) {
                    // User is authenticated, proceed to checkout
                    window.location.href = '/Checkout';
                } else {
                    // User is not authenticated, redirect to login
                    // Store the return URL in session storage
                    sessionStorage.setItem('returnUrl', '/Checkout');
                    window.location.href = '/Auth/Login';
                }
            };
        });
    </script>
    <script src="/js/cart.js"></script>
    <script src="/js/menu-animations.js"></script>
    <script src="/js/image-fallback.js"></script>
    <script src="/js/menu-image-handler.js"></script>
}